<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>éŠ€è¡Œå°æ‡‰å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3"></script>
    <style>
        /* é è¨­ä¸»é¡Œï¼ˆlight modeï¼‰ä¸‹çš„èƒŒæ™¯èˆ‡æ–‡å­—é¡è‰² */
        body {
            background-color: #f8f9fa; /* æ·ºç°è‰²èƒŒæ™¯ */
            color: #212529; /* æ·±ç°æ–‡å­—ï¼ˆBootstrap é è¨­æ–‡å­—è‰²ï¼‰ */
        }

        /* ç•¶ HTML å…ƒç´ å…·æœ‰ data-bs-theme="dark" æ™‚ï¼Œå¥—ç”¨æ·±è‰²èƒŒæ™¯èˆ‡äº®è‰²æ–‡å­— */
        [data-bs-theme="dark"] body {
            background-color: #212529 !important; /* æ·±ç°èƒŒæ™¯ */
            color: #f8f9fa !important; /* ç™½è‰²æ–‡å­— */
        }

        /* çµ±ä¸€è¨­å®šè¡¨å–®æ¬„ä½ï¼ˆè¼¸å…¥æ¡†ã€ä¸‹æ‹‰é¸å–®ã€æ–‡å­—å€ï¼‰æ–‡å­—å¤§å° */
        textarea, select, input {
            font-size: 0.9rem !important;
        }

        /* è¡¨å–®æ¬„ä½åœ¨ light mode çš„èƒŒæ™¯èˆ‡æ–‡å­—é¡è‰² */
        .form-control, .form-select {
            background-color: #f5f5f5; /* æ·ºç°åº•è‰² */
            color: #000; /* é»‘è‰²æ–‡å­— */
        }

        /* è¡¨å–®æ¬„ä½åœ¨ dark mode çš„èƒŒæ™¯èˆ‡æ–‡å­—é¡è‰² */
        [data-bs-theme="dark"] .form-control,
        [data-bs-theme="dark"] .form-select {
            background-color: #343a40; /* æ·±ç°åº•è‰² */
            color: #f8f9fa; /* ç™½è‰²æ–‡å­— */
        }

        /* è¡¨å–® label åŠ ç²—ä»¥çªé¡¯æ¬„ä½åç¨± */
        .form-label {
            font-weight: bold;
        }

        /* èª¿æ•´æŒ‰éˆ•å­—é«”å¤§å° */
        .btn {
            font-size: 0.85rem;
        }

        /* ç‚ºæ¯æ¬„ä½è¨­å®šå…§é‚Šè·ï¼Œè®“ç•«é¢çœ‹èµ·ä¾†æ›´æ•´é½Š */
        .row .col {
            padding: 6px 12px;
        }
    </style>
</head>
<body>
<div id="app" class="container">
    <!-- Vue åº”ç”¨çš„å†…å®¹å°†ä¼šåœ¨è¿™é‡Œæ¸²æŸ“ -->
</div>

<template id="original-content">
    <div class="mb-3">
        <label  class="form-label">1. é¸æ“‡å¸ç§</label>
        <select v-model="currencySelect" @change="changeCurrency" class="form-select" aria-label="Default select example">
            <option v-for="currencyT in currencyArr" :value="currencyT">{{currencyT}}</option>
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">1-1. å–ä»£å­—ä¸²</label>
        <textarea class="form-control" v-model="finalReplaceStrList" rows="3"></textarea>
    </div>
    <div class="mb-3 form-check form-switch">
        <label class="form-check-label" for="removeBracketsIn"><input id="removeBracketsIn" role="switch" class="form-check-input" type="checkbox" v-model="removeBracketsIn">&nbsp;ç§»é™¤æ‹¬è™Ÿå…§çš„å…§å®¹</label> <br>
        <label class="form-check-label" for="removeBracketsOut"><input id="removeBracketsOut" role="switch" class="form-check-input" type="checkbox" v-model="removeBracketsOut">&nbsp;ç§»é™¤æ‹¬è™Ÿå¤–çš„å…§å®¹</label>
    </div>
    <hr>
    <div class="mb-3">
        <label class="form-label">2. é‡‘æµå•†é“¶è¡Œä»£ç (è²¼ä¸ŠæŒ‡å®šæ ¼å¼)
            <select v-model="thirdPartyBankCodeTypeSelect" @change="onChangeThirdPartyBankDataType">
                <option v-for="item in thirdPartyBankCodeType">{{item.type}}</option>
            </select>
        </label>
        <textarea class="form-control" v-model="thirdPartyBankCodeData" rows="3"  :placeholder="thirdPartyBankCodeSample"></textarea>
        <button type="button" class="btn btn-primary" @click="generateQuerySql">ğŸ‘†äº§ç”ŸDBæŸ¥è¯¢SQL</button>
    </div>
    <hr>

    <div class="mb-3">
        <label class="form-label">3. å‰å¾€DBï¼ŒåŸ·è¡Œä¸‹æ–¹çš„æŸ¥è¯¢SQL</label>
        <textarea class="form-control" v-model="generateQuerySqlResult" rows="3" disabled></textarea>
    </div>
    <hr>
    <div class="mb-3">
        <label class="form-label">4. è²¼ä¸Šä¸Šåˆ—SQLçš„DBåŸ·è¡Œçµæœ(æ ¼å¼ï¼šjson) </label>
        <textarea class="form-control" v-model="dbDataJsonStr" rows="3"></textarea>

        <button type="button" class="btn btn-primary" @click="execJson">ğŸ‘†äº§ç”ŸBANKCODEä¸‹æ‹‰é¸å–®mappingè¡¨æ ¼</button>
    </div>

    <div class="container text-center">
        <div class="row" v-for="item in dataList">
            <div class="col col-1">
                <input type="checkbox" v-model="item.support">
            </div>
            <div class="col col-3">
                {{ item.inputName }}
            </div>
            <div class="col col-4">
                <select class="form-select" aria-label="Default select example" v-model="item.bankName">
                    <option v-for="bankName in item.bankNames">
                        {{ bankName }}
                    </option>
                </select>
            </div>
            <div class="col col-4">
                <input v-model="item.bankName">
            </div>
        </div>
    </div>
    <hr>
    <div class="mb-3">
        <label class="form-label">5. å°‡è¡¨æ ¼è½‰æ›æˆæœ€ç»ˆç»“æœ
            <button type="button" class="btn btn-primary" @click="generateFinalResult">ğŸ‘†äº§ç”Ÿ(javaæ ¼å¼)</button></label>
        <textarea class="form-control" v-model="finalResult" rows="3" disabled></textarea>
    </div>
</template>

<script>
    const { createApp, ref } = Vue;
    let app = createApp({
        data() {
            return {
                currencyArr: [
                    "vnd",
                    "inr",
                    "brl",
                    "thb",
                    "pkr",
                    "myr",
                    "idr",
                    "php",
                    "usd",
                    "ngn",
                    "mxn",
                    "zar",
                    "try",
                    "kes",
                    "cop",
                    "bdt",
                    "egp",
                    "pen",
                    "eur",
                    "rmb",
                    "jpy",
                    "krw",
                    "twd",
                    "clp",
                    "rub",
                    "sgd"
                ],
                message: 'test',
                removeBracketsIn: false,
                removeBracketsOut: false,
                currencySelect: null,
                finalReplaceStrList: "",
                thirdPartyBankCodeTypeSelect: 'json1',
                thirdPartyBankCodeData: null,
                generateQuerySqlResult: null,
                dbDataJsonStr:null,
                dataList: null,
                finalResult: null,
                defaultReplaceTarget: ['bank', '\\', '/', ' - '],
                currencyReplaceTarget: {
                    "thb": ['plc.', 'ltd', 'limited', 'na'],
                    "idr": ['pt.', 'tbk', '(persero)', 'na'],
                    "vnd": ['nh', 'ngan hang', 'tmcp']
                },
                thirdPartyBankCodeType: [
                    {
                        type: 'json1',
                        sample: '{"thirdBankName":"thirdBankCode","å»ºè®¾é“¶è¡Œ":"001"}'
                    },
                    {
                        type: 'json2',
                        sample: '{"thirdBankCode":"thirdBankName","001":"å»ºè®¾é“¶è¡Œ"}'
                    },
                    {
                        type: 'csv1',
                        sample: 'thirdBankName,thirdBankCode\nå»ºè®¾é“¶è¡Œ,001'
                    },
                    {
                        type: 'csv2',
                        sample: 'thirdBankCode,thirdBankName\n001,å»ºè®¾é“¶è¡Œ'
                    },
                ],
                thirdPartyBankCodeSample: '{"thirdBankName":"thirdBankCode","å»ºè®¾é“¶è¡Œ":"001"}',
            }
        },
        methods: {
            onChangeThirdPartyBankDataType() {
                this.thirdPartyBankCodeSample = '';
                this.thirdPartyBankCodeType.forEach(type => {
                    if (type.type === this.thirdPartyBankCodeTypeSelect) {
                        this.thirdPartyBankCodeSample = type.sample;
                    }
                })
            },
            generateQuerySql() {
                if (this.currencySelect === null || this.currencySelect.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©å¸ç§');
                    return;
                }
                if (this.thirdPartyBankCodeData === null || this.thirdPartyBankCodeData.length === 0) {
                    alert('è¯·å…ˆè¾“å…¥é‡‘æµå•†é“¶è¡Œèµ„è®¯');
                    return;
                }
                let sqlArr = []
                let bankObj = {};
                switch (this.thirdPartyBankCodeTypeSelect) {
                    case 'json1':
                        bankObj = JSON.parse(this.thirdPartyBankCodeData);
                        break;
                    case 'json2':
                        let temp = JSON.parse(this.thirdPartyBankCodeData);
                        Object.keys(temp).forEach(key => bankObj[temp[key]] = key);
                        break;
                    case 'csv1':
                        let dataArr = this.thirdPartyBankCodeData.split('\n');
                        dataArr.forEach(dataStr => {
                            let bankData = dataStr.split(',');
                            bankObj[bankData[0]] = bankData[1];
                        })
                        break;
                    case 'csv2':
                        let dataArr2 = this.thirdPartyBankCodeData.split('\n');
                        dataArr2.forEach(dataStr => {
                            let bankData = dataStr.split(',');
                            bankObj[bankData[1]] = bankData[0];
                        })
                        break;
                    default:
                        alert('ä¸æ”¯æ´çš„èµ„æ–™æ ¼å¼');
                        return;
                }
                let checkCodeSet = new Set();
                Object.keys(bankObj).forEach((key) => {
                    if (checkCodeSet.has(bankObj[key])) {
                        alert('é‡‘æµå•†é“¶è¡Œå¯¹åº”ä»£ç å‡ºç°é‡å¤:' + bankObj[key])
                        return;
                    }
                    checkCodeSet.add(bankObj[key])
                    let likeKey = this.preprocessingKey(key);
                    let templateSql = `SELECT group_concat(BankName SEPARATOR '@SEP@') as bankNames, '${bankObj[key]}' AS code, '${key}' AS inputName
                                        FROM t_withdraw_channel_bank_code
                                        WHERE BankName LIKE '%${likeKey}%' AND Currency = '${this.currencySelect}'
                                        UNION
                                        SELECT NULL AS bankNames, '${bankObj[key]}' AS code, '${key}' AS inputName
                                        FROM DUAL
                                        WHERE NOT EXISTS (
                                            SELECT 1
                                            FROM t_withdraw_channel_bank_code
                                            WHERE BankName LIKE '%${likeKey}%' AND Currency = '${this.currencySelect}'
                                        ) group by Code, InputName `;
                    sqlArr.push(templateSql);
                });
                this.generateQuerySqlResult = "SELECT JSON_ARRAYAGG( " +
                    "           JSON_OBJECT( " +
                    "               'bankNames', bankNames, " +
                    "               'code', code, " +
                    "               'inputName', inputName " +
                    "           ) " +
                    "       ) AS jsonArray " +
                    "FROM ( " + sqlArr.join("\nUNION\n") + " ) AS subquery;";
            },
            changeCurrency() {
                let currencyReplaceTargetElement = this.currencyReplaceTarget[this.currencySelect];
                this.finalReplaceStrList = this.defaultReplaceTarget.join('\n') + (typeof currencyReplaceTargetElement === 'undefined' ? '' : ('\n' + currencyReplaceTargetElement.join('\n')));
            },
            execJson() {
                // [
                //     {
                //         "bankNames": "LienvietpostBank,LIENVIETPOSTBANK(LPB)",
                //         "code": "test",
                //         "inputName": "LienvietpostBank"
                //     }
                // ]
                let dataArr = JSON.parse(this.dbDataJsonStr);
                let id = 1;
                dataArr.forEach(data => {
                    data['support'] = true
                    data['id'] = id++;
                    data['bankNames'] = (data['bankNames'] === null || data['bankNames'].length === 0) ? [] : data['bankNames'].split('@SEP@');
                    data['bankName'] = data['bankNames'].length === 0 ? '' : data['bankNames'][0];
                })
                console.log(dataArr);
                this.dataList = dataArr;
            },
            generateFinalResult() {
                //æ£€æŸ¥é“¶è¡Œåç§°æ˜¯å¦æœ‰é‡å¤
                let checkNameSet = new Set();
                let checkCodeSet = new Set();
                let tempArr = [];
                this.dataList.forEach(data => {
                    if (!data.support) {
                        return;
                    }
                    if (checkNameSet.has(data.bankName)) {
                        alert('æœ‰é‡å¤çš„é“¶è¡Œåç§°:' + data.bankName);
                        return
                    }
                    tempArr.push("bankCode.put(\"" + data.bankName + "\",\"" + data.code + "\"); //" + data.inputName );
                })
                this.finalResult = tempArr.join("\n");
            },
            preprocessingKey(keyName) {
                if (keyName === null || keyName.length === 0) {
                    return '';
                }

                if (this.removeBracketsIn) {
                    keyName = keyName.replaceAll(/\(.*?\)/g, '')
                }
                if (this.removeBracketsOut) {
                    keyName = keyName.replaceAll(/.*?\((.*?)\).*/g, '$1')
                }
                this.finalReplaceStrList.split('\n').forEach(v => {
                    keyName = keyName.replace(v, '');
                })
                return keyName.trim();
            }
        },
        mounted() {
            // åœ¨è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€äº›ç»„ä»¶åˆå§‹åŒ–çš„é€»è¾‘
        },
        template: '#original-content'
    });
    app.mount('#app');

    // ================================
    // ä¸»é¡Œåµæ¸¬èˆ‡åŒæ­¥ï¼ˆå­é ï¼‰
    // ================================

    // ç›£è½çˆ¶é ä¸»é¡Œè¨Šæ¯ï¼ˆæš—/äº®ä¸»é¡Œï¼‰
    window.addEventListener('message', (event) => {
        const theme = event.data?.theme;
        if (theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
        }
    });

    // ä¸»å‹•è©¢å•çˆ¶é ï¼šè«‹å•ç›®å‰ä¸»é¡Œï¼Ÿ
    window.parent?.postMessage({ ask: 'theme' }, '*');
</script>
</body>
</html>
